# Платформа онлайн-курсов

## Обзор

Платформа онлайн-курсов — это RESTful API для управления курсами, аутентификации пользователей и контроля доступа на основе ролей (RBAC). Пользователи могут регистрироваться, входить в систему, обновлять профиль, записываться на курсы и управлять контентом в зависимости от их ролей (администратор, преподаватель, студент, гость). Приложение использует кастомную систему аутентификации с JWT-токенами и bcrypt для хэширования паролей, обеспечивая безопасные и stateless-сессии.

## Технологический стек

- **Фреймворк бэкенда**: Django 5.2
- **Фреймворк для API**: Django REST Framework 3.16
- **База данных**: PostgreSQL
- **Аутентификация**: Кастомная реализация JWT с использованием PyJWT
- **Хэширование паролей**: bcrypt
- **Управление окружением**: python-dotenv
- **Зависимости**: uv

## Контроль доступа на основе ролей (RBAC)

Система RBAC управляет правами доступа пользователей в зависимости от их роли. Структура RBAC включает:

- **Модели**:

  - `Role`: Определяет роли пользователей (например, администратор, преподаватель, студент, гость).
  - `BusinessElement`: Представляет ресурсы (например, пользователи, курсы, записи, правила доступа).
  - `AccessRolesRule`: Связывает роли с ресурсами и задает права:
    - `read_permission` / `read_all_permission`: Чтение своих/всех ресурсов.
    - `create_permission`: Создание ресурсов.
    - `update_permission` / `update_all_permission`: Обновление своих/всех ресурсов.
    - `delete_permission` / `delete_all_permission`: Удаление своих/всех ресурсов.

- **Роли**:

  - **Администратор**: Полный доступ ко всем ресурсам (чтение, создание, обновление, удаление).
  - **Преподаватель**: Может создавать и управлять своими курсами, просматривать свои записи.
  - **Студент**: Может просматривать все курсы, управлять своими записями.
  - **Гость**: Может только просматривать курсы (присваивается неаутентифицированным пользователям).

- **Реализация**:
  - Права проверяются в API-представлениях через запросы к `AccessRolesRule` на основе `request.user.role`.
  - Неаутентифицированные пользователи получают временный объект `GuestUser` с ролью `guest` в middleware `JWTMiddleware`.

## Схема работы приложения

1. **Аутентификация**:

   - Регистрация через `/auth/register/` с вводом email, пароля и личных данных.
   - Вход через `/auth/login/` возвращает JWT-токен, действительный 24 часа.
   - JWT-токены передаются в заголовке `Authorization: Bearer <token>` для аутентифицированных запросов.
   - Middleware `JWTMiddleware` проверяет токены и устанавливает `request.user` (пользователь или гость).
   - Выход (`/auth/logout/`) выполняется на стороне клиента удалением токена.
   - Обновление профиля (`/auth/profile/`) позволяет частично изменять данные пользователя.
   - Мягкое удаление (`DELETE /auth/profile/`) устанавливает `is_active=False`, запрещая вход.

2. **Управление курсами**:

   - Курсы создаются преподавателями или администраторами (`POST /api/courses/`).
   - Все роли (включая гостей) могут просматривать курсы (`GET /api/courses/`).
   - Студенты и администраторы могут записываться на курсы (`POST /api/enrollments/`).

3. **Управление RBAC**:

   - Администраторы могут управлять ролями, бизнес-элементами и правилами через `/rbac/roles/`, `/rbac/elements/`, `/rbac/rules/`.

4. **Админ-панель**:
   - Используется Django Admin (`/admin/`) для управления пользователями, курсами, записями и RBAC.
   - Работает на сессионной аутентификации, не затрагивая JWT.

## Эндпоинты API

| Эндпоинт                           | Метод  | Описание                           | Доступ                     |
| ---------------------------------- | ------ | ---------------------------------- | -------------------------- |
| `/auth/register/`                  | POST   | Регистрация нового пользователя    | Публичный                  |
| `/auth/login/`                     | POST   | Вход и получение JWT-токена        | Публичный                  |
| `/auth/logout/`                    | POST   | Выход (удаление токена на клиенте) | Аутентифицированные        |
| `/auth/profile/`                   | PATCH  | Обновление профиля пользователя    | Аутентифицированные        |
| `/auth/profile/`                   | DELETE | Мягкое удаление аккаунта           | Аутентифицированные        |
| `/rbac/roles/`                     | GET    | Список ролей                       | Администратор              |
| `/rbac/roles/`                     | POST   | Создание роли                      | Администратор              |
| `/rbac/roles/<int:role_id>/`       | PATCH  | Обнавление роли                    | Администратор              |
| `/rbac/elements/`                  | GET    | Список бизнес-элементов            | Администратор              |
| `/rbac/elements/`                  | POST   | Создание бизнес-элемента           | Администратор              |
| `/rbac/elements/<int:element_id>/` | PATCH  | Обнавление бизнес-элемента         | Администратор              |
| `/rbac/rules/`                     | GET    | Список правил доступа              | Администратор              |
| `/rbac/rules/`                     | POST   | Создание правила доступа           | Администратор              |
| `/rbac/rules/<int:rule_id>/`       | PATCH  | Обнавление правила доступа         | Администратор              |
| `/api/courses/`                    | GET    | Список всех курсов                 | Все (включая гостей)       |
| `/api/courses/`                    | POST   | Создание курса                     | Преподаватель, Админ       |
| `/api/enrollments/`                | GET    | Список записей (свои/все, по RBAC) | Аутентифицированные (RBAC) |
| `/api/enrollments/`                | POST   | Запись на курс                     | Студент, Администратор     |

## Установка

Установить зависимости и активация виртуального окружения

```bash
uv sync
sourse .venv/bin/activate
```

Запустить базу данных

```bash
docker compose up -d
```

Сделать миграции и загрузить данные в бд

```bash
cd backend
python manage.py makemigrations
python manage.py migrate
python manage.py loaddata fixtures/data.json
```

### Требования

- Python 3.13
- PostgreSQL
- Git
- Docker
- uv
